# Channel

In the interactive version of the STARK protocol there is a bi-directional communication channel between prover and verifier. In particular verifier would generate and send random queries, and prover would respond to those queries.

In the non-interactive setting the parties do not communicate, instead they are talking to a random oracle (implemented as hash function). Both prover and verifier keep protocol transcripts in a deterministic manner, so that they match. Random query is generated by hashing the transcript up to the current state.

## Channel state and time

Stwo uses "so-far digest" channel model where parties do not compute a hash of the entire (so-far) transcript every time they need to derive randomness, but instead maintain intermediate digest of the previous transcript. This digest (also referred to as "channel state") is updated every time prover sends a message.

In order to draw randomness we hash the current state with a counter (also referred to as "channel time"), that increases after each attempt and resets when the state is updated.

## Drawing random values

It's important not to use channel state as randomness directly as it reduces protocol security. Challenges (random queries) must only depend on the transcript history, not on another challenges.

### Random M31 elements

The hash $H(state, counter)$ is interpreted as a vector of `u32` words (little endian) and then each word is reduced modulo $P=2^{31}-1$.

In order to ensure uniform distribution we need to check if all words lie inside the $[0, 2P)$ interval, otherwise the probability of drawing $1$ would be higher than for other M31 elements.

The probability that any of the words is equal `0xfffffffe` ($2^{32}-1$) is pretty low though, so one round is enough in most of times.

### Random QM31 element

In order to draw a random `QM31` we draw random `M31` (typically 8 per hash) and then take first 4. If we need to draw many `QM31` elements, we just draw more base field elements and then iterate over them in chunks of size 4 (so that we fully utilize all the obtained random values).

### Random circle point

Given a random field element $t$ we need to derive the coordinates such that $y = \sqrt{1 - x^2}$ exists (a quadratic residue) in the underlying field:

$P=(\frac{1-t^2}{1+t^2}, \frac{2t}{1+t^2})$

## References

- https://www.starknet.io/blog/safe-and-sound-a-deep-dive-into-stark-security/
- Fiat-Shamir in the Wild https://eprint.iacr.org/2024/1565.pdf
